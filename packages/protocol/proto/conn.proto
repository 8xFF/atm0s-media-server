syntax = "proto2";

import "shared.proto";

package conn;

message Request {
    message Session {
        message RoomJoin {
            required shared.RoomJoin info = 1;
            required string token = 2;
        }

        message RoomLeave {

        }

        message UpdateSdp {
            required shared.Tracks tracks = 1;
            required string sdp = 2;
        }

        message Disconnect {

        }

        oneof request {
            RoomJoin join = 1;
            RoomLeave leave = 2;
            UpdateSdp sdp = 3;
            Disconnect disconnect = 4;
        }
    }

    message Sender {
        message Attach {
            required shared.Sender.Source source = 1;
            required shared.Sender.Config config = 2;
        }

        message Detach {

        }

        required string name = 1;
        oneof request {
            Attach attach = 2;
            Detach detach = 3;
            shared.Sender.Config config = 4;
        }
    }

    message Receiver {
        message Attach {
            required shared.Receiver.Source source = 1;
            required shared.Receiver.Config config = 2;
        }

        message Detach {

        }

        required string name = 1;
        oneof request {
            Attach attach = 2;
            Detach detach = 3;
            shared.Receiver.Config config = 4;
        }
    }

    required uint32 req_id = 1;
    oneof request {
        Session session = 2;
        Sender sender = 3;
        Receiver receiver = 4;
    }
}

message Response {
    message Session {
        message RoomJoin {

        }

        message RoomLeave {

        }

        message UpdateSdp {
            required string sdp = 1;
        }

        message Disconnect {

        }

        oneof response {
            RoomJoin join = 1;
            RoomLeave leave = 2;
            UpdateSdp sdp = 3;
            Disconnect disconnect = 4;
        }
    }

    message Sender {
        message Attach {

        }

        message Detach {

        }

        message Config {

        }

        oneof response {
            Attach attach = 1;
            Detach detach = 2;
            Config config = 3;
        }
    }

    message Receiver {
        message Attach {

        }

        message Detach {

        }

        message Config {

        }

        oneof response {
            Attach attach = 1;
            Detach detach = 2;
            Config config = 3;
        }
    }

    required uint32 req_id = 1;
    oneof response {
        shared.Error error = 2;
        Session session = 3;
        Sender sender = 4;
        Receiver receiver = 5;
    }
}

message ServerEvent {
    message Session {
        message Connected {

        }

        message JoinedRoom {
            required string room = 1;
            required string peer = 2;
            required string token = 3;
        }

        message LeavedRoom {
            required string room = 1;
            required string peer = 2;
        }

        message Disconnected {
            required string reason =  1;
        }

        oneof event {
            Connected connected = 1;
            JoinedRoom joined = 2;
            LeavedRoom leaved = 3;
            Disconnected disconnected = 4;
        }
    }

    message Room {
        message PeerJoined {
            required string peer = 1;
            optional string metadata = 2;
        }

        message PeerUpdated {
            required string peer = 1;
            optional string metadata = 2;
        }

        message PeerLeaved {
            required string peer = 1;
        }

        message TrackStarted {
            required string peer = 1;
            required string track = 2;
            required shared.Kind kind = 3;
            optional string metadata = 4;
        }

        message TrackUpdated {
            required string peer = 1;
            required string track = 2;
            required shared.Kind kind = 3;
            optional string metadata = 4;
        }

        message TrackStopped {
            required string peer = 1;
            required string track = 2;
            required shared.Kind kind = 3;
        }

        oneof event {
            PeerJoined peer_joined = 1;
            PeerUpdated peer_updated = 2;
            PeerLeaved peer_leaved = 3;
            TrackStarted track_started = 4;
            TrackUpdated track_updated = 5;
            TrackStopped track_stopped = 6;
        }
    }

    message Sender {
        message State {
            enum StateType {
                WAITING = 0;
                NO_SOURCE = 1;
                ACTIVE = 2;
                INACTIVE = 3;
            }

            required StateType state = 1;
        }

        required string name = 1;
        oneof event {
            State state = 2;
        }
    }

    message Receiver {
        message State {
            enum StateType {
                NO_SOURCE = 0;
                WAITING = 1;
                LIVE = 2;
                INACTIVE = 3;
            }

            required StateType state = 1;
        }

        message Stats {
            message Source {
                required uint32 bitrate_kbps = 1;
                required float rtt = 2;
                required float lost = 3;
                required float jitter = 4;
            }

            message Transmit {
                required uint32 spatial = 1;
                required uint32 temporal = 2;
                required uint32 bitrate_kbps = 3;
            }

            optional Source source = 1;
            optional Transmit transmit = 2;
        }

        required string name = 1;
        oneof event {
            State state = 2;
            Stats stats = 3;
        }
    }

    required uint32 seq = 1;
    oneof event {
        Session session = 2;
        Room room = 3;
        Sender sender = 4;
        Receiver receiver = 5;
        Response response = 6;
    }
}

message ClientEvent {
    required uint32 seq = 1;
    oneof event {
        Request request = 2;
    }
}
